tinymce.PluginManager.add('jdragdrop', function(editor) {

	// Reset the drop area border
	tinyMCE.DOM.bind(document, 'dragleave', function(e) {
		e.stopPropagation();
		e.preventDefault();
		tinyMCE.activeEditor.contentAreaContainer.style.borderWidth='';

		return false;
	});

	// The upload logic
	function UploadFile(file) {
		var errorMsgs = [];
		var fd = new FormData();
		fd.append('Filedata', file);
		fd.append('folder', mediaUploadPath);

		jQuery.ajax({
			url: uploadUri,
			type: 'post',
			enctype: 'multipart/form-data',
			data: fd,
			async: false,
			cache: false,
			contentType: false,
			processData: false,
			success: function(data){
				if (data.status == 0) {
					if (data.dataUrl) {
						tinyMCE.activeEditor.windowManager.alert(data.error + ': ' + setCustomDir + data.dataUrl);
					}
					setTimeout(function(){ jQuery('#jloader').remove(); }, 200);
				}
				if (data.status == 1) {
					// Create the image tag
					var newNode = tinyMCE.activeEditor.getDoc().createElement ('img');
					newNode.src= setCustomDir + data.dataUrl;
					tinyMCE.activeEditor.execCommand('mceInsertContent', false, newNode.outerHTML);
					setTimeout(function(){ jQuery('#jloader').remove(); }, 200);
				}
			},
			error: function(errorThrown){
				setTimeout(function(){ jQuery('#jloader').remove(); }, 100);
			}
		});
	}

	// Listers for drag and drop
	if (typeof FormData != 'undefined'){

		// Fix for Chrome
		editor.on('dragenter', function(e) {
			e.stopPropagation();

			return false;
		});


		// Notify user when file is over the drop area
		editor.on('dragover', function(e) {
				e.preventDefault();
				tinyMCE.activeEditor.contentAreaContainer.style.borderColor = 'green'
				tinyMCE.activeEditor.contentAreaContainer.style.borderStyle = 'dashed'
				tinyMCE.activeEditor.contentAreaContainer.style.borderWidth = '5px';

				return false;
		});

		// Logic fro the droped file
		editor.on('drop', function(e) {
			// We override only for files
			if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
				for (var i = 0, f; f = e.dataTransfer.files[i]; i++) {
					var ext = f.name.split('.').pop().toLowerCase();
					if (jQuery.inArray(ext, ['gif', 'png', 'jpg', 'jpeg']) != -1) {
						editor.contentAreaContainer.style.borderWidth = '';
						jQuery('<div id=\"jloader\" />').css({
							position  : 'absolute',
							width     : '100%',
							height    : '100%',
							left      : 0,
							top       : 0,
							opacity   : 0.55,
							zIndex    : 1000000,
							background: 'url(/media/jui/img/ajax-loader.gif) #fff no-repeat 50% 50%'
						}).appendTo(jQuery('.editor').css('position', 'relative'));

						editor.contentAreaContainer.style.borderWidth = '';

						// Upload the file(s)
						UploadFile(f);
						e.preventDefault();

						return false;
					}
				}
			}
			editor.contentAreaContainer.style.borderWidth = '';
		});
	} else {
		Joomla.renderMessages({'error': [Joomla.JText._("PLG_TINY_ERR_UNSUPPORTEDBROWSER")]});
		editor.on('drop', function(e) {
			e.preventDefault();

			return false;
		});
	}
});
